<div class="budgets-container">
  <!-- Header -->
  <div class="header">
    <h1>Mes Budgets</h1>
    <button mat-raised-button color="primary" (click)="openAddDialog()">
      <mat-icon>add</mat-icon>
      Nouveau budget
    </button>
  </div>

  <!-- Barre de recherche -->
  <mat-form-field appearance="outline" class="search-field">
    <mat-label>Rechercher</mat-label>
    <input matInput (keyup)="applyFilter($event)" placeholder="Nom, catégorie, montant...">
    <mat-icon matPrefix>search</mat-icon>
  </mat-form-field>

  <!-- Loader -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Chargement des budgets...</p>
  </div>

  <!-- Tableau -->
  <div *ngIf="!loading" class="table-container">
    <table mat-table [dataSource]="dataSource" matSort class="budgets-table">
      
      <!-- Name Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Nom</th>
        <td mat-cell *matCellDef="let budget">
          <strong>{{ budget.name }}</strong>
        </td>
      </ng-container>

      <!-- Category Column -->
      <ng-container matColumnDef="category">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Catégorie</th>
        <td mat-cell *matCellDef="let budget">
          <mat-chip [style.background-color]="budget.category.color || '#ccc'">
            <mat-icon *ngIf="budget.category.icon">{{ budget.category.icon }}</mat-icon>
            {{ budget.category.name }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Period Column -->
      <ng-container matColumnDef="period">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Période</th>
        <td mat-cell *matCellDef="let budget">
          <div class="period-cell">
            <span>{{ budget.startDate | date:'dd/MM/yyyy' }}</span>
            <mat-icon>arrow_forward</mat-icon>
            <span>{{ budget.endDate | date:'dd/MM/yyyy' }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Amount Column -->
      <ng-container matColumnDef="amount">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Budget</th>
        <td mat-cell *matCellDef="let budget">
          <span class="amount">{{ budget.amount | number:'1.2-2' }} €</span>
        </td>
      </ng-container>

      <!-- Spent Column -->
      <ng-container matColumnDef="spent">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Dépensé</th>
        <td mat-cell *matCellDef="let budget">
          <span class="spent" [class.over]="budget.isOverBudget">
            {{ budget.spentAmount | number:'1.2-2' }} €
          </span>
        </td>
      </ng-container>

      <!-- Progress Column -->
      <ng-container matColumnDef="progress">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Progression</th>
        <td mat-cell *matCellDef="let budget">
          <div class="progress-cell">
            <mat-progress-bar 
              mode="determinate" 
              [value]="budget.percentageUsed > 100 ? 100 : budget.percentageUsed"
              [color]="getProgressColor(budget)">
            </mat-progress-bar>
            <span class="percentage" [ngClass]="getStatusClass(budget)">
              {{ budget.percentageUsed | number:'1.0-0' }}%
            </span>
          </div>
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Statut</th>
        <td mat-cell *matCellDef="let budget">
          <span class="status-badge" [ngClass]="getStatusClass(budget)">
            {{ getStatusLabel(budget) }}
          </span>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let budget">
          <button mat-icon-button [matMenuTriggerFor]="menu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="openEditDialog(budget)">
              <mat-icon>edit</mat-icon>
              <span>Modifier</span>
            </button>
            <button mat-menu-item (click)="deleteBudget(budget.id)">
              <mat-icon color="warn">delete</mat-icon>
              <span>Supprimer</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="budget-row"></tr>

      <!-- Message si aucune donnée -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          <div class="no-data">
            <mat-icon>inbox</mat-icon>
            <p>Aucun budget trouvé</p>
          </div>
        </td>
      </tr>
    </table>

    <!-- Pagination -->
    <mat-paginator 
      [pageSizeOptions]="[10, 25, 50]"
      showFirstLastButtons
      aria-label="Sélectionner la page des budgets">
    </mat-paginator>
  </div>
</div>
